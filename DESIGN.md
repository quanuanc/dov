# DOV 技术设计文档

## 1. 项目概述

DOV (Data Over Video) 是一个通过 HDMI 信号传输文件的工具。

### 工作原理

```
电脑 A (Sender)                          电脑 B (Receiver)
┌─────────────┐                         ┌─────────────┐
│  文件       │                         │  采集卡      │
│    ↓        │      HDMI 线缆          │    ↓        │
│  编码为视频  │ ───────────────────────→│  视频解码    │
│    ↓        │                         │    ↓        │
│  屏幕输出    │                         │  恢复文件    │
└─────────────┘                         └─────────────┘
```

### 技术栈

- 语言：Java 21
- 构建工具：Maven
- 视频输出：JavaFX
- 视频采集：JavaCV (OpenCV)
- 目标硬件：1080P-60Hz 采集卡

---

## 2. 技术约束与挑战

### 2.1 采集卡的实际限制

| 问题 | 影响 | 应对策略 |
|------|------|----------|
| MJPEG/H.264 压缩 | 色彩失真、边缘模糊 | 使用大像素块、二值编码 |
| 帧率不稳定 | 可能只有 20-30fps，有丢帧 | 帧内自同步、重复发送 |
| 边缘裁剪 | 边缘几个像素可能丢失 | 预留安全边距 |
| 色彩空间转换 | RGB→YUV→RGB 有损失 | 只使用亮度通道 |

### 2.2 单向通信的挑战

HDMI 是单向传输，Sender 无法得知：
- Receiver 是否已启动
- Receiver 是否成功接收了某帧
- 是否需要重传

**解决思路**：Sender 不依赖反馈，通过冗余和状态帧来保证可靠性。

---

## 3. 编码方案

### 3.1 像素编码：8x8 块二值编码

每个 8x8 像素块代表 1 bit 数据：

```
1 bit = 8×8 = 64 个像素

黑块 (0)：所有像素值设为 0
白块 (1)：所有像素值设为 255

解码判定：计算块内像素平均值
- 平均值 < 128 → 0
- 平均值 ≥ 128 → 1
```

**为什么选择 8x8**：
- JPEG DCT 块正好是 8x8，块内平均亮度不受压缩影响
- 即使边缘模糊，中心区域仍然可靠
- 抗噪声能力强

### 3.2 容量计算

```
1080P 分辨率：1920 × 1080 像素
8x8 块网格：240 × 135 = 32,400 bits/帧

扣除开销后：
- 安全边距：16 像素（2 块）
- 可用网格：236 × 131 块
- 帧头 + 校验：约 6 行块
- 数据区域：约 236 × 125 = 29,500 bits ≈ 3.6 KB/帧

考虑纠错开销（~30%）：
- 有效数据：约 2.5 KB/帧
```

### 3.3 带宽预期

| 场景 | 实际帧率 | 有效带宽 | 传输 1MB | 传输 10MB |
|------|----------|----------|----------|-----------|
| 理想 | 30 fps | ~75 KB/s | ~14 秒 | ~2.5 分钟 |
| 一般 | 20 fps | ~50 KB/s | ~20 秒 | ~3.5 分钟 |
| 较差 | 15 fps | ~37 KB/s | ~27 秒 | ~4.5 分钟 |

---

## 4. 帧格式设计

### 4.1 帧布局

```
┌─────────────────────────────────────────────────────────────┐
│                      安全边距 (16 像素)                      │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐   │
│  │  定位角标 (4 个角各 32×32 像素)                       │   │
│  │  ┌──┐                                         ┌──┐  │   │
│  │  │▓▓│  左上：全黑                  右上：全白  │░░│  │   │
│  │  └──┘                                         └──┘  │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  帧头区域 (3 行块 = 24 像素高)                       │   │
│  │  魔数 + 帧类型 + 帧序号 + 数据长度 + 校验            │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │                                                     │   │
│  │                    数据区域                         │   │
│  │                 约 236 × 120 块                     │   │
│  │                 ≈ 2.5 KB 有效数据                   │   │
│  │                                                     │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  校验区域 (2 行块)                                  │   │
│  │  CRC32 + Reed-Solomon 冗余码                        │   │
│  │  ┌──┐                                         ┌──┐  │   │
│  │  │░░│  左下：全白                  右下：全黑  │▓▓│  │   │
│  │  └──┘                                         └──┘  │   │
│  └─────────────────────────────────────────────────────┘   │
│                      安全边距 (16 像素)                      │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 定位角标

用于快速判断是否为有效数据帧，并检测几何偏移：

```
位置        颜色      用途
─────────────────────────────
左上角      全黑      基准点
右上角      全白      水平边界检测
左下角      全白      垂直边界检测
右下角      全黑      对角校验
```

检测算法：
1. 扫描四个角的预期位置
2. 验证颜色模式是否匹配
3. 如果匹配，确认为有效数据帧
4. 根据实际角标位置计算偏移量

---

## 5. 协议设计

### 5.1 帧类型

| 类型 | 值 | 用途 | 发送策略 |
|------|-----|------|----------|
| IDLE | 0x00 | Sender 空闲状态 | 持续循环显示 |
| START | 0x01 | 传输开始，携带文件元信息 | 重复 5 次 |
| DATA | 0x02 | 数据帧 | 每帧重复 3 次 |
| EOF | 0x03 | 传输结束 | 重复 5 次 |

### 5.2 帧头结构

#### 通用帧头（10 字节）

```
偏移  长度  字段
────────────────────────
0     2     魔数 (0x44, 0x56 = "DV")
2     1     帧类型
3     4     帧序号 (大端序)
7     2     数据长度
9     1     保留
```

#### START 帧数据区

```
偏移  长度  字段
────────────────────────
0     1     文件名长度 N
1     N     文件名 (UTF-8)
N+1   8     文件大小 (uint64, 大端序)
N+9   4     总帧数 (uint32)
N+13  32    文件 SHA-256
N+45  4     传输参数
```

#### DATA 帧数据区

```
偏移  长度  字段
────────────────────────
0     ~2KB  文件数据块
...   32    Reed-Solomon 校验码
...   4     CRC32
```

#### EOF 帧数据区

```
偏移  长度  字段
────────────────────────
0     4     总帧数
4     32    文件 SHA-256 (重复验证)
```

### 5.3 传输时序

```
Receiver                                      Sender
   │                                            │
   │ 启动，进入扫描状态                           │
   │ ◄──────────────────────────────────────────┤ (无信号)
   │                                            │
   │                                            │ 启动
   │ ◄─────────── IDLE ─────────────────────────┤
   │ ◄─────────── IDLE ─────────────────────────┤
   │              ...                           │
   │ 检测到 IDLE，显示"已连接"                    │
   │                                            │
   │                                            │ 用户选择文件
   │                                            │
   │ ◄─────────── START ────────────────────────┤ ×5
   │ 收到 START，提取文件信息                     │
   │ 显示"开始接收: xxx.zip"                     │
   │                                            │
   │ ◄─────────── DATA[0] ──────────────────────┤ ×3
   │ ◄─────────── DATA[1] ──────────────────────┤ ×3
   │              ...                           │
   │ 按帧序号去重存储，显示进度                    │
   │                                            │
   │ ◄─────────── EOF ──────────────────────────┤ ×5
   │ 收到 EOF，重组文件，校验                     │
   │ 显示"接收完成"                              │
   │                                            │
   │ ◄─────────── IDLE ─────────────────────────┤
```

---

## 6. 状态机

### 6.1 Sender 状态机

```
                    ┌─────────────────┐
         ┌─────────│      IDLE       │◄────────────────┐
         │         │ 显示 IDLE 帧     │                 │
         │         └────────┬────────┘                 │
         │                  │ 用户选择文件              │
         │                  ▼                          │
         │         ┌─────────────────┐                 │
         │         │   PREPARING     │                 │
         │         │ 计算 SHA-256    │                 │
         │         │ 分块编码生成帧   │                 │
         │         └────────┬────────┘                 │
         │                  │                          │
         │                  ▼                          │
         │         ┌─────────────────┐                 │
         │         │  SENDING_START  │                 │
         │         │ 发送 START × 5  │                 │
         │         └────────┬────────┘                 │
         │                  │                          │
         │                  ▼                          │
         │         ┌─────────────────┐                 │
  用户取消          │  SENDING_DATA   │                 │
         │         │ 发送每帧 × 3    │                 │
         │         └────────┬────────┘                 │
         │                  │ 所有帧发送完毕            │
         │                  ▼                          │
         │         ┌─────────────────┐                 │
         │         │   SENDING_EOF   │                 │
         │         │ 发送 EOF × 5    │                 │
         │         └────────┬────────┘                 │
         │                  │                          │
         └──────────────────┴──────────────────────────┘
```

### 6.2 Receiver 状态机

```
                    ┌─────────────────┐
         ┌─────────│    SCANNING     │◄────────────────┐
         │         │ 扫描有效帧       │                 │
         │         └────────┬────────┘                 │
         │                  │ 检测到 IDLE 帧            │
         │                  ▼                          │
         │         ┌─────────────────┐                 │
         │         │    CONNECTED    │                 │
         │         │ 等待 START 帧   │                 │
         │         └────────┬────────┘                 │
         │                  │ 收到 START 帧            │
         │                  ▼                          │
         │         ┌─────────────────┐                 │
         │         │   RECEIVING     │                 │
  超时/错误         │ 接收 DATA 帧    │                 │
         │         │ 显示进度        │                 │
         │         └────────┬────────┘                 │
         │                  │ 收到 EOF 帧              │
         │                  ▼                          │
         │         ┌─────────────────┐                 │
         │         │   ASSEMBLING    │                 │
         │         │ 重组文件        │                 │
         │         │ 校验 SHA-256    │                 │
         │         └────────┬────────┘                 │
         │                  │                          │
         │                  ▼                          │
         │         ┌─────────────────┐                 │
         │         │    COMPLETE     │                 │
         │         │ 或 ERROR        │─────────────────┘
         │         └─────────────────┘   用户确认后
         │
         └─────────────────────────────────────────────┘
```

---

## 7. 纠错机制

### 7.1 三层纠错

```
第一层：块级别
- 8×8 像素块通过平均值判定
- 天然抗噪，容忍局部像素错误

第二层：帧级别
- Reed-Solomon (255, 223)
- 每 223 字节数据 + 32 字节校验
- 可纠正最多 16 字节错误

第三层：文件级别
- 整个文件计算 SHA-256
- START 和 EOF 帧都携带校验和
- 接收完成后验证完整性
```

### 7.2 丢帧处理

```
发送端：每帧重复发送 3 次
接收端：按帧序号去重
  - 同一帧序号多次收到 → 保留第一个有效帧
  - 如果校验失败 → 尝试使用后续收到的同序号帧

EOF 后检查：
  - 检查是否有缺失的帧序号
  - 如有缺失 → 报告错误，显示丢失帧列表
```

---

## 8. 容错处理

### 8.1 异常场景

| 场景 | 处理方式 |
|------|----------|
| Receiver 中途启动（错过 START） | 显示警告，等待下一个 START 帧 |
| Sender 中途重启 | Receiver 收到新 START，丢弃当前数据，重新开始 |
| 持续丢帧 | EOF 后报告缺失帧列表 |
| 长时间无有效帧 | 超时（30秒）后回到 SCANNING 状态 |
| 校验失败 | 报告错误，显示期望和实际的 SHA-256 |

---

## 9. UI 设计

### 9.1 Sender UI（JavaFX 全屏）

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│              主显示区域（编码后的帧图像）                     │
│                 用于 HDMI 输出                              │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  [控制面板 - 按 ESC 显示/隐藏]                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 状态: 空闲 / 发送中                                  │   │
│  │ 文件: example.zip (1.2 MB)                          │   │
│  │ 进度: ████████░░░░░░░░ 50%  帧 125/250              │   │
│  │                                                     │   │
│  │ [选择文件]  [开始发送]  [取消]  [退出]               │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘

快捷键：
  ESC   - 显示/隐藏控制面板
  Space - 开始/暂停
  Q     - 退出程序
```

### 9.2 Receiver UI（普通窗口）

```
┌─────────────────────────────────────────────────────────────┐
│  DOV Receiver                                        [─][□][×]│
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  采集设备: [USB Video ▼]  [刷新]                             │
│                                                             │
│  ┌─ 预览 ─────────────────────────────────────────────────┐ │
│  │                                                         │ │
│  │         (采集卡画面预览，缩小显示)                        │ │
│  │                                                         │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  状态: ● 已连接 - 等待传输 / ○ 扫描中 / ● 接收中              │
│                                                             │
│  当前文件: example.zip                                       │
│  文件大小: 1.2 MB                                            │
│  进度: ████████████░░░░░░░░ 60%                              │
│  帧: 150/250  丢失: 0                                        │
│                                                             │
│  保存位置: ~/Downloads/                                      │
│  [更改...]                                                  │
│                                                             │
│  [开始接收]  [停止]                                          │
└─────────────────────────────────────────────────────────────┘
```

---

## 10. 模块结构

```
dov/
├── pom.xml                 # 父 POM
├── protocol/               # 共享协议模块
│   ├── pom.xml
│   └── src/main/java/dev/cheng/dov/protocol/
│       ├── Constants.java          # 全局常量
│       ├── codec/
│       │   ├── BlockCodec.java     # 8×8 块编解码
│       │   └── FrameCodec.java     # 帧编解码
│       ├── frame/
│       │   ├── FrameType.java      # 帧类型枚举
│       │   ├── FrameHeader.java    # 帧头结构
│       │   ├── FrameLayout.java    # 帧布局计算
│       │   └── FrameDetector.java  # 帧检测（角标识别）
│       ├── ecc/
│       │   └── ReedSolomon.java    # 纠错编码
│       └── file/
│           ├── FileChunker.java    # 文件分块
│           └── FileAssembler.java  # 文件重组
│
├── sender/                 # 发送端模块
│   ├── pom.xml
│   └── src/main/java/dev/cheng/dov/sender/
│       ├── SenderApp.java          # JavaFX 主程序
│       ├── SenderState.java        # 状态枚举
│       ├── SenderController.java   # 发送控制逻辑
│       ├── FrameRenderer.java      # 帧渲染器
│       └── ui/
│           └── ControlPanel.java   # 控制面板组件
│
└── receiver/               # 接收端模块
    ├── pom.xml
    └── src/main/java/dev/cheng/dov/receiver/
        ├── ReceiverApp.java        # 主程序
        ├── ReceiverState.java      # 状态枚举
        ├── ReceiverController.java # 接收控制逻辑
        ├── CaptureDevice.java      # 采集设备封装
        ├── FrameAnalyzer.java      # 帧分析器
        └── ui/
            ├── MainWindow.java     # 主窗口
            └── PreviewPanel.java   # 预览面板
```

---

## 11. 配置参数

```java
public class TransferConfig {
    // === 帧重复次数 ===
    int startFrameRepeat = 5;       // START 帧重复次数
    int dataFrameRepeat = 3;        // DATA 帧重复次数
    int eofFrameRepeat = 5;         // EOF 帧重复次数

    // === 时序控制 ===
    int frameIntervalMs = 50;       // 帧间隔 (20fps)
    int idleFrameIntervalMs = 200;  // IDLE 帧间隔 (省资源)

    // === 超时设置 ===
    int connectionTimeoutSec = 60;  // 连接超时
    int frameTimeoutSec = 10;       // 帧超时

    // === 编码参数 ===
    int blockSize = 8;              // 像素块大小
    int safeMargin = 16;            // 安全边距 (像素)
    int cornerSize = 32;            // 角标大小 (像素)

    // === 分辨率 ===
    int frameWidth = 1920;          // 帧宽度
    int frameHeight = 1080;         // 帧高度
}
```

---

## 12. 依赖库

### 12.1 protocol 模块

```xml
<dependencies>
    <!-- Reed-Solomon 纠错 -->
    <dependency>
        <groupId>com.backblaze.b2</groupId>
        <artifactId>b2-sdk-core</artifactId>
        <version>6.1.1</version>
    </dependency>
</dependencies>
```

### 12.2 sender 模块

```xml
<dependencies>
    <dependency>
        <groupId>dev.cheng</groupId>
        <artifactId>protocol</artifactId>
        <version>${project.version}</version>
    </dependency>

    <!-- JavaFX -->
    <dependency>
        <groupId>org.openjfx</groupId>
        <artifactId>javafx-controls</artifactId>
        <version>21</version>
    </dependency>
    <dependency>
        <groupId>org.openjfx</groupId>
        <artifactId>javafx-graphics</artifactId>
        <version>21</version>
    </dependency>
</dependencies>
```

### 12.3 receiver 模块

```xml
<dependencies>
    <dependency>
        <groupId>dev.cheng</groupId>
        <artifactId>protocol</artifactId>
        <version>${project.version}</version>
    </dependency>

    <!-- JavaCV (OpenCV) -->
    <dependency>
        <groupId>org.bytedeco</groupId>
        <artifactId>javacv-platform</artifactId>
        <version>1.5.9</version>
    </dependency>
</dependencies>
```

---

## 13. 开发计划

### Phase 1：基础验证
- [ ] 创建 protocol 模块基础结构
- [ ] 实现 BlockCodec（8×8 块编解码）
- [ ] 实现基础 FrameLayout
- [ ] Sender：JavaFX 显示测试图案
- [ ] Receiver：JavaCV 采集验证

### Phase 2：核心功能
- [ ] 实现完整帧格式（帧头、数据区、校验区）
- [ ] 实现 FrameDetector（角标检测）
- [ ] 实现 FrameCodec（完整帧编解码）
- [ ] 单帧数据传输测试

### Phase 3：完整传输
- [ ] 实现 FileChunker 和 FileAssembler
- [ ] 添加 Reed-Solomon 纠错
- [ ] 实现状态机
- [ ] 端到端文件传输测试

### Phase 4：UI 完善
- [ ] Sender 控制面板
- [ ] Receiver 完整 UI
- [ ] 进度显示和错误处理
